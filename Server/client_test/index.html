<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script type="text/javascript" src="lib/signalr/signalr.js"></script>
</head>
<body>
    <script type="text/javascript">

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/api/v1/ws")
            .build();

        connection.start().then(() => {
            console.log("connected");

            reloadSoundList();

            connection.on("OnFileEvent", () => {
                reloadSoundList();
            });

            document.getElementById("btnStop").addEventListener("click", () => {
                connection.invoke("Stop");
            });

            document.getElementById("btnUpload").addEventListener("click", () => {
                const file = document.getElementById("inpFileUpload").files[0];
                new FileUpload(file, getSelectedUploadDirectory());
            });

            document.getElementById("btnNewDirectory").addEventListener("click", () => {
                const name = document.getElementById("inpNewDirectory").value;
                const directory =
                {
                    Name: name,
                    FileName: name
                };
                connection.invoke("MakeDirectory", directory, getSelectedUploadDirectory());
            });
        });

        function FileUpload(file, directory) {
          const reader = new FileReader();  
          const xhr = new XMLHttpRequest();
          this.xhr = xhr;
  
          const self = this;
          //this.xhr.upload.addEventListener("progress", function(e) {
          //      if (e.lengthComputable) {
          //        const percentage = Math.round((e.loaded * 100) / e.total);
          //        self.ctrl.update(percentage);
          //      }
          //    }, false);
  
          //xhr.upload.addEventListener("load", function(e){
          //        self.ctrl.update(100);
          //        const canvas = self.ctrl.ctx.canvas;
          //        canvas.parentNode.removeChild(canvas);
          //}, false);

            var url = "/api/v1/rest/sound?name=" + encodeURIComponent(file.name);
            if (directory) {
                url += "&directory=" + encodeURIComponent(JSON.stringify(directory));
            }

            xhr.open("POST", url);

          //xhr.open("POST", "http://demos.hacks.mozilla.org/paul/demos/resources/webservices/devnull.php");
            //xhr.overrideMimeType('text/plain; charset=x-user-defined-binary');
            xhr.setRequestHeader("Content-Type", "application/octet-stream");
            xhr.setRequestHeader("Content-Length", file.size);
          reader.onload = function(evt) {
            xhr.send(evt.target.result);
          };
          reader.readAsArrayBuffer(file);
        }

        function reloadSoundList() {
            fetchSoundList().then(result => {

                buildSoundList(result);

                console.log(result);
            }).catch(err => {
                console.error(err);
            });
        }

        function fetchSoundList() {
            return new Promise((resolve, reject) => {
                connection.invoke("GetSounds", null, true)
                    .then(result => {
                        resolve(result[0]);
                    })
                    .catch(cause => {
                        reject(cause);
                    });
            });
        }

        function buildSoundList(sounds) {
            var container = document.getElementById("lstSounds");
            container.innerHTML = "";

            container.appendChild(buildDirectory(sounds));
        }

        function buildDirectory(directory) {

            var itemDirectory = document.createElement("li");

            var chkbxDirectory = document.createElement("input");
            chkbxDirectory.type = "radio";
            chkbxDirectory.className = "directory-rdbtn-select-upload";
            chkbxDirectory.name = "directory-rdbtn-select-upload";
            chkbxDirectory.id = directory.id;
            itemDirectory.appendChild(chkbxDirectory);

            var spName = document.createElement("label");
            spName.textContent = directory.name;
            spName.htmlFor = chkbxDirectory.id;
            itemDirectory.appendChild(spName);

            var lstChildren = document.createElement("ul");
            for (var i = 0; i < directory.children.length; ++i) {
                let child = directory.children[i];

                if (child.children) {
                    //is directory
                    lstChildren.appendChild(buildDirectory(child));
                }
                else {
                    var itemSound = document.createElement("li");

                    var btnSound = document.createElement("input");
                    btnSound.type = "button";
                    btnSound.value = child.name;
                    btnSound.addEventListener("click", () => {
                        connection.invoke("Play", {
                            Sounds: [
                                {
                                    Sound: child
                                }
                            ]
                        });
                    });
                    itemSound.appendChild(btnSound);

                    lstChildren.appendChild(itemSound);
                }
            }
            itemDirectory.appendChild(lstChildren);

            return itemDirectory;
        }

        function getSelectedUploadDirectory() {
            var radios = document.getElementsByClassName("directory-rdbtn-select-upload");
            if (radios) {
                for (var i = 0; i < radios.length; ++i) {
                    if (radios[i].checked) {
                        return {
                            ID: radios[i].id
                        }
                    }
                }
            }

            return null;
        }

    </script>
    <div id="lstSounds"></div>
    <input type="button" id="btnStop" value="Stop" />
    <div>
        <input type="file" id="inpFileUpload" />
        <input type="button" id="btnUpload" value="Upload" />
    </div>
    <div>
        <input type="text" id="inpNewDirectory" />
        <input type="button" id="btnNewDirectory" value="New Directory" />
    </div>
</body>
</html>