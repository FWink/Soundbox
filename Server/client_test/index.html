<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <script type="text/javascript" src="lib/signalr/signalr.js"></script>
</head>
<body>
    <script type="text/javascript">

        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/api/v1/ws")
            .build();

        connection.start().then(() => {
            console.log("connected");

            reloadSoundList();

            connection.on("OnFileEvent", () => {
                reloadSoundList();
            });

            document.getElementById("btnStop").addEventListener("click", () => {
                connection.invoke("Stop");
            });

            document.getElementById("btnUpload").addEventListener("click", () => {
                const file = document.getElementById("inpFileUpload").files[0];
                new FileUpload(file, getSelectedUploadDirectory());
            });

            document.getElementById("btnNewDirectory").addEventListener("click", () => {
                const name = document.getElementById("inpNewDirectory").value;
                const directory =
                {
                    Name: name
                };
                connection.invoke("MakeDirectory", directory, getSelectedUploadDirectory());
            });

            document.getElementById("btnModify").addEventListener("click", () => {
                const name = document.getElementById("inpModifyName").value;

                const file = getSelectedNode();
                file.Name = name;

                connection.invoke("Edit", file);
            });
            
            document.getElementById("btnVolumePlus").addEventListener("click", () => {

                var volume = getVolume() + 5;
                connection.invoke("SetVolume", volume);
            });
            document.getElementById("btnVolumeMinus").addEventListener("click", () => {

                var volume = getVolume() - 5;
                connection.invoke("SetVolume", volume);
            });
            connection.on("OnVolumeChanged", function (event) {
                document.getElementById("spVolume").innerText = event;
            });
            connection.invoke("GetVolume").then(function (event) {
                document.getElementById("spVolume").innerText = event;
            });
            
            document.getElementById("btnDelete").addEventListener("click", () => {

                connection.invoke("Delete", getSelectedNode());
            });
        });

        function FileUpload(file, directory) {
            const reader = new FileReader();
            const xhr = new XMLHttpRequest();
            this.xhr = xhr;

            const self = this;
            //this.xhr.upload.addEventListener("progress", function(e) {
            //      if (e.lengthComputable) {
            //        const percentage = Math.round((e.loaded * 100) / e.total);
            //        self.ctrl.update(percentage);
            //      }
            //    }, false);

            //xhr.upload.addEventListener("load", function(e){
            //        self.ctrl.update(100);
            //        const canvas = self.ctrl.ctx.canvas;
            //        canvas.parentNode.removeChild(canvas);
            //}, false);

            var sound = {
                Name: file.name,
                FileName: file.name
            };

            var url = "/api/v1/rest/sound?sound=" + encodeURIComponent(JSON.stringify(sound));
            if (directory) {
                url += "&directory=" + encodeURIComponent(JSON.stringify(directory));
            }

            xhr.open("POST", url);

            //xhr.open("POST", "http://demos.hacks.mozilla.org/paul/demos/resources/webservices/devnull.php");
            //xhr.overrideMimeType('text/plain; charset=x-user-defined-binary');
            xhr.setRequestHeader("Content-Type", "application/octet-stream");
            xhr.setRequestHeader("Content-Length", file.size);
            reader.onload = function (evt) {
                xhr.send(evt.target.result);
            };
            reader.readAsArrayBuffer(file);
        }

        function reloadSoundList() {
            fetchSoundList().then(result => {

                buildSoundList(result);

                console.log(result);
            }).catch(err => {
                console.error(err);
            });
        }

        function fetchSoundList() {
            return new Promise((resolve, reject) => {
                connection.invoke("GetSounds", null, true)
                    .then(result => {
                        resolve(result[0]);
                    })
                    .catch(cause => {
                        reject(cause);
                    });
            });
        }

        function buildSoundList(sounds) {
            var container = document.getElementById("lstSounds");
            container.innerHTML = "";

            container.appendChild(buildDirectory(sounds));
        }

        function buildDirectory(directory) {

            var itemDirectory = document.createElement("li");

            var chkbxDirectory = document.createElement("input");
            chkbxDirectory.type = "radio";
            chkbxDirectory.className = "directory-rdbtn-select-upload";
            chkbxDirectory.name = "directory-rdbtn-select-upload";
            chkbxDirectory.id = directory.id;
            itemDirectory.appendChild(chkbxDirectory);

            var spName = document.createElement("label");
            spName.textContent = directory.name;
            spName.htmlFor = chkbxDirectory.id;
            itemDirectory.appendChild(spName);

            var lstChildren = document.createElement("ul");
            for (var i = 0; i < directory.children.length; ++i) {
                let child = directory.children[i];

                if (child.children) {
                    //is directory
                    lstChildren.appendChild(buildDirectory(child));
                }
                else {
                    var itemSound = document.createElement("li");

                    var btnSound = document.createElement("input");
                    btnSound.type = "button";
                    btnSound.value = child.name;
                    btnSound.addEventListener("click", () => {
                        connection.invoke("Play", {
                            Sounds: [
                                {
                                    Sound: child
                                }
                            ]
                        });
                    });
                    itemSound.appendChild(btnSound);

                    lstChildren.appendChild(itemSound);
                }
            }
            itemDirectory.appendChild(lstChildren);

            return itemDirectory;
        }

        function getSelectedUploadDirectory() {
            var radios = document.getElementsByClassName("directory-rdbtn-select-upload");
            if (radios) {
                for (var i = 0; i < radios.length; ++i) {
                    if (radios[i].checked) {
                        return {
                            ID: radios[i].id
                        }
                    }
                }
            }

            return null;
        }

        function getSelectedNode() {
            return getSelectedUploadDirectory();
        }

        function getVolume() {
            var volume = 100;

            var span = document.getElementById("spVolume");
            if (span && span.innerText) {
                volume = parseInt(span.innerText);

                if (isNaN(volume))
                    volume = 100;
            }

            return volume;
        }

    </script>
    <div id="lstSounds"></div>
    <input type="button" id="btnStop" value="Stop" />
    <div>
        <input type="file" id="inpFileUpload" />
        <input type="button" id="btnUpload" value="Upload" />
    </div>
    <div>
        <input type="text" id="inpNewDirectory" />
        <input type="button" id="btnNewDirectory" value="New Directory" />
    </div>
    <div>
        <input type="text" id="inpModifyName" />
        <input type="button" id="btnModify" value="Edit" />
    </div>
    <div>
        Volume:
        <span id="spVolume"></span>
        <button type="button" id="btnVolumePlus">+</button>
        <button type="button" id="btnVolumeMinus">-</button>
    </div>
    <div>
        <button type="button" id="btnDelete">Delete</button>
    </div>
</body>
</html>